#!/usr/share/ucs-test/runner python
# -*- coding: utf-8 -*-
## desc: Test UDM APIs LDAP connection initialization feature
## exposure: dangerous
## roles: [domaincontroller_master]
## packages: [python-univention-directory-manager]
## bugs: [47316]

from unittest import main, TestCase
import univention.debug as ud
from univention.testing.udm import UCSTestUDM, UCSTestUDM_CreateUDMObjectFailed
from univention.testing.ucr import UCSTestConfigRegistry
import univention.testing.strings as uts
import univention.admin.uldap
from univention.udm import Udm


ud.init('/var/log/univention/directory-manager-cmd.log', ud.FLUSH, 0)
ud.set_level(ud.ADMIN, ud.ALL)


class TestUdmAutoOpen(TestCase):
	ucr_test = None
	udm_test = None

	@classmethod
	def setUpClass(cls):
		cls.udm_test = UCSTestUDM()
		cls.ucr_test = UCSTestConfigRegistry()
		cls.ucr_test.load()

	@classmethod
	def tearDownClass(cls):
		cls.ucr_test.revert_to_original_registry()
		cls.udm_test.cleanup()

	def test_using_lo(self):
		lo, po = univention.admin.uldap.getAdminConnection()
		udm = Udm(lo)
		assert udm.lo.binddn == 'cn=admin,{}'.format(self.ucr_test['ldap/base'])

		lo, po = univention.admin.uldap.getMachineConnection()
		udm = Udm(lo)
		assert udm.lo.binddn == self.ucr_test['ldap/hostdn']

	def test_using_admin(self):
		udm = Udm.using_admin()
		assert udm.lo.binddn == 'cn=admin,{}'.format(self.ucr_test['ldap/base'])

	def test_using_machine(self):
		udm = Udm.using_machine()
		assert udm.lo.binddn == self.ucr_test['ldap/hostdn']

	def test_using_credentials(self):
		password = uts.random_name()
		dn, username = self.udm_test.create_user(password=password)
		udm = Udm.using_credentials(username=username, password=password)
		assert udm.lo.binddn == dn

		password = uts.random_name()
		dn, username = self.udm_test.create_user(password=password)
		udm = Udm.using_credentials(dn=dn, password=password)
		assert udm.lo.binddn == dn


if __name__ == '__main__':
	main(verbosity=2)
